!function(e,n,t){var r=e,o=4,i=1,c=2,s=1,a=65535,u=1,l=7,f=r.Package={},d=r.Message={};f.TYPE_HANDSHAKE=1,f.TYPE_HANDSHAKE_ACK=2,f.TYPE_HEARTBEAT=3,f.TYPE_DATA=4,f.TYPE_KICK=5,d.TYPE_REQUEST=0,d.TYPE_NOTIFY=1,d.TYPE_RESPONSE=2,d.TYPE_PUSH=3,r.strencode=function(e){for(var t=new n(3*e.length),r=0,o=0;o<e.length;o++){var i=e.charCodeAt(o),c=null;c=127>=i?[i]:2047>=i?[192|i>>6,128|63&i]:[224|i>>12,128|(4032&i)>>6,128|63&i];for(var s=0;s<c.length;s++)t[r]=c[s],++r}var a=new n(r);return h(a,0,t,0,r),a},r.strdecode=function(e){for(var t=new n(e),r=[],o=0,i=0,c=t.length;c>o;)t[o]<128?(i=t[o],o+=1):t[o]<224?(i=((63&t[o])<<6)+(63&t[o+1]),o+=2):(i=((15&t[o])<<12)+((63&t[o+1])<<6)+(63&t[o+2]),o+=3),r.push(i);return String.fromCharCode.apply(null,r)},f.encode=function(e,t){var r=t?t.length:0,i=new n(o+r),c=0;return i[c++]=255&e,i[c++]=r>>16&255,i[c++]=r>>8&255,i[c++]=255&r,t&&h(i,c,t,0,r),i},f.decode=function(e){for(var t=0,r=new n(e),o=0,i=[];t<r.length;){var c=r[t++];o=(r[t++]<<16|r[t++]<<8|r[t++])>>>0;var s=o?new n(o):null;h(s,0,r,t,o),t+=o,i.push({type:c,body:s})}return 1===i.length?i[0]:i},d.encode=function(e,t,o,a,u){var l=p(t)?y(e):0,f=i+l;if(v(t))if(o){if("number"!=typeof a)throw new Error("error flag for number route!");f+=c}else if(f+=s,a){if(a=r.strencode(a),a.length>255)throw new Error("route maxlength is overflow");f+=a.length}u&&(f+=u.length);var d=new n(f),h=0;return h=E(t,o,d,h),p(t)&&(h=T(e,d,h)),v(t)&&(h=_(o,a,d,h)),u&&(h=w(u,d,h)),d},d.decode=function(e){var t=new n(e),o=t.length||t.byteLength,i=0,c=0,s=null,a=t[i++],f=a&u,d=a>>1&l;if(p(d)){var y=parseInt(t[i]),E=0;do{var y=parseInt(t[i]);c+=(127&y)*Math.pow(2,7*E),i++,E++}while(y>=128)}if(v(d))if(f)s=t[i++]<<8|t[i++];else{var T=t[i++];T?(s=new n(T),h(s,0,t,i,T),s=r.strdecode(s)):s="",i+=T}var _=o-i,w=new n(_);return h(w,0,t,i,_),{id:c,type:d,compressRoute:f,route:s,body:w}};var h=function(e,n,t,r,o){if("function"==typeof t.copy)t.copy(e,n,r,r+o);else for(var i=0;o>i;i++)e[n++]=t[r++]},p=function(e){return e===d.TYPE_REQUEST||e===d.TYPE_RESPONSE},v=function(e){return e===d.TYPE_REQUEST||e===d.TYPE_NOTIFY||e===d.TYPE_PUSH},y=function(e){var n=0;do n+=1,e>>=7;while(e>0);return n},E=function(e,n,t,r){if(e!==d.TYPE_REQUEST&&e!==d.TYPE_NOTIFY&&e!==d.TYPE_RESPONSE&&e!==d.TYPE_PUSH)throw new Error("unkonw message type: "+e);return t[r]=e<<1|(n?1:0),r+i},T=function(e,n,t){do{var r=e%128,o=Math.floor(e/128);0!==o&&(r+=128),n[t++]=r,e=o}while(0!==e);return t},_=function(e,n,t,r){if(e){if(n>a)throw new Error("route number is overflow");t[r++]=n>>8&255,t[r++]=255&n}else n?(t[r++]=255&n.length,h(t,r,n,0,n.length),r+=n.length):t[r++]=0;return r},w=function(e,n,t){return h(n,t,e,0,e.length),t+e.length};"undefined"!=typeof window&&(window.Protocol=r)}("undefined"==typeof window?module.exports:this.Protocol={},"undefined"==typeof window?Buffer:Uint8Array,this),function(){function e(e){return e?n(e):void 0}function n(n){for(var t in e.prototype)n[t]=e.prototype[t];return n}e.prototype.on=e.prototype.addEventListener=function(e,n){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(n),this},e.prototype.once=function(e,n){function t(){r.off(e,t),n.apply(this,arguments)}var r=this;return this._callbacks=this._callbacks||{},t.fn=n,this.on(e,t),this},e.prototype.off=e.prototype.removeListener=e.prototype.removeAllListeners=e.prototype.removeEventListener=function(e,n){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var t=this._callbacks[e];if(!t)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var r,o=0;o<t.length;o++)if(r=t[o],r===n||r.fn===n){t.splice(o,1);break}return this},e.prototype.emit=function(e){this._callbacks=this._callbacks||{};var n=[].slice.call(arguments,1),t=this._callbacks[e];if(t){t=t.slice(0);for(var r=0,o=t.length;o>r;++r)t[r].apply(this,n)}return this},e.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},e.prototype.hasListeners=function(e){return!!this.listeners(e).length};var t="js-websocket",r="0.0.1",o=window.Protocol,i=null,c=null,s=o.Package,a=o.Message,u=e,l=window.rsa,f=200,d=501;"function"!=typeof Object.create&&(Object.create=function(e){function n(){}return n.prototype=e,new n});var h=window,p=Object.create(u.prototype);h.nano=p;var v,y=null,E=0,T={},_={},w={},g={},b={},m=0,P=0,Y=0,k=100,A=null,S=null,N=null,O=null,H=null,R=!1,K=null,D=null,U=0,C=5e3,I=10,J={sys:{type:t,version:r,rsa:{}},user:{}},L=null;p.init=function(e,n){L=n;var t=e.host,r=e.port;H=e.encode||Q,O=e.decode||B;var o="ws://"+t;if(r&&(o+=":"+r),J.user=e.user,e.encrypt){v=!0,l.generate(1024,"10001");var i={rsa_n:l.n.toString(16),rsa_e:l.e};J.sys.rsa=i}N=e.handshakeCallback,j(e,o,n)};var B=p.decode=function(e){var n=a.decode(e);if(!(n.id>0)||(n.route=w[n.id],delete w[n.id],n.route))return n.body=$(n),n},Q=p.encode=function(e,n,t){var r=e?a.TYPE_REQUEST:a.TYPE_NOTIFY;if(i&&i.lookup(n)){var c=i.build(n);t=new c(t).encodeNB()}else t=o.strencode(JSON.stringify(t));var s=0;return g&&g[n]&&(n=g[n],s=1),a.encode(e,r,s,n,t)},j=function(e,n,t){console.log("connect to "+n);var e=e||{},r=e.maxReconnectAttempts||I;D=n;var i=function(e){R&&p.emit("reconnect"),F();var n=s.encode(s.TYPE_HANDSHAKE,o.strencode(JSON.stringify(J)));x(n)},c=function(e){X(s.decode(e.data),t),P&&(Y=Date.now()+P)},a=function(e){p.emit("io-error",e),console.error("socket error: ",e)},u=function(n){p.emit("close",n),p.emit("disconnect",n),console.log("socket close: ",n),e.reconnect&&r>U&&(R=!0,U++,K=setTimeout(function(){j(e,D,t)},C),C*=2)};y=new WebSocket(n),y.binaryType="arraybuffer",y.onopen=i,y.onmessage=c,y.onerror=a,y.onclose=u};p.disconnect=function(){y&&(y.disconnect&&y.disconnect(),y.close&&y.close(),console.log("disconnect"),y=null),A&&(clearTimeout(A),A=null),S&&(clearTimeout(S),S=null)};var F=function(){R=!1,C=5e3,U=0,clearTimeout(K)};p.request=function(e,n,t){2===arguments.length&&"function"==typeof n?(t=n,n={}):n=n||{},e=e||n.route,e&&(E++,M(E,e,n),T[E]=t,w[E]=e)},p.notify=function(e,n){n=n||{},M(0,e,n)};var M=function(e,n,t){if(v){t=JSON.stringify(t);var r=l.signString(t,"sha256");t=JSON.parse(t),t.__crypto__=r}H&&(t=H(e,n,t));var o=s.encode(s.TYPE_DATA,t);x(o)},x=function(e){y.send(e.buffer)},q=function(e){if(m){var n=s.encode(s.TYPE_HEARTBEAT);S&&(clearTimeout(S),S=null),A||(A=setTimeout(function(){A=null,x(n),Y=Date.now()+P,S=setTimeout(W,P)},m))}},W=function(){var e=Y-Date.now();e>k?S=setTimeout(W,e):(console.error("server heartbeat timeout"),p.emit("heartbeat timeout"),p.disconnect())},z=function(e){if(e=JSON.parse(o.strdecode(e)),e.code===d)return void p.emit("error","client version not fullfill");if(e.code!==f)return void p.emit("error","handshake fail");en(e);var n=s.encode(s.TYPE_HANDSHAKE_ACK);x(n),L&&L(y)},G=function(e){var n=e;O&&(n=O(n)),Z(p,n)},V=function(e){e=JSON.parse(o.strdecode(e)),p.emit("onKick",e)};_[s.TYPE_HANDSHAKE]=z,_[s.TYPE_HEARTBEAT]=q,_[s.TYPE_DATA]=G,_[s.TYPE_KICK]=V;var X=function(e){if(Array.isArray(e))for(var n=0;n<e.length;n++){var t=e[n];_[t.type](t.body)}else _[e.type](e.body)},Z=function(e,n){if(!n.id)return void e.emit(n.route,n.body);var t=T[n.id];delete T[n.id],"function"==typeof t&&t(n.body)},$=function(e){var n=e.route;if(e.compressRoute){if(!b[n])return{};n=e.route=b[n]}return c&&c.lookup(n)?c.build(n).decode(e.body):JSON.parse(o.strdecode(e.body))},en=function(e){e.sys&&e.sys.heartbeat?(m=1e3*e.sys.heartbeat,P=2*m):(m=0,P=0),nn(e),"function"==typeof N&&N(e.user)},nn=function(e){if(e&&e.sys){if(g=e.sys.dict){g=g,b={};for(var n in g)b[g[n]]=n}window.nano=p}}}();