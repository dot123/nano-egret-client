!function(e,p){var y=e,n=y.Package={},o=y.Message={};n.TYPE_HANDSHAKE=1,n.TYPE_HANDSHAKE_ACK=2,n.TYPE_HEARTBEAT=3,n.TYPE_DATA=4,n.TYPE_KICK=5,o.TYPE_REQUEST=0,o.TYPE_NOTIFY=1,o.TYPE_RESPONSE=2,o.TYPE_PUSH=3,y.strencode=function(e){for(var n=new p(3*e.length),t=0,r=0;r<e.length;r++){var o=e.charCodeAt(r),i=null;i=o<=127?[o]:o<=2047?[192|o>>6,128|63&o]:[224|o>>12,128|(4032&o)>>6,128|63&o];for(var c=0;c<i.length;c++)n[t]=i[c],++t}var s=new p(t);return v(s,0,n,0,t),s},y.strdecode=function(e){for(var n=new p(e),t=[],r=0,o=0,i=n.length;r<i;)n[r]<128?(o=n[r],r+=1):n[r]<224?(o=((63&n[r])<<6)+(63&n[r+1]),r+=2):(o=((15&n[r])<<12)+((63&n[r+1])<<6)+(63&n[r+2]),r+=3),t.push(o);return String.fromCharCode.apply(null,t)},n.encode=function(e,n){var t=n?n.length:0,r=new p(4+t),o=0;return r[o++]=255&e,r[o++]=t>>16&255,r[o++]=t>>8&255,r[o++]=255&t,n&&v(r,4,n,0,t),r},n.decode=function(e){for(var n=0,t=new p(e),r=0,o=[];n<t.length;){var i=t[n++],c=(r=(t[n++]<<16|t[n++]<<8|t[n++])>>>0)?new p(r):null;v(c,0,t,n,r),n+=r,o.push({type:i,body:c})}return 1===o.length?o[0]:o},o.encode=function(e,n,t,r,o){var i=1+(E(n)?l(e):0);if(T(n))if(t){if("number"!=typeof r)throw new Error("error flag for number route!");i+=2}else if(i+=1,r){if(255<(r=y.strencode(r)).length)throw new Error("route maxlength is overflow");i+=r.length}o&&(i+=o.length);var c=new p(i),s=0;return s=a(n,t,c,s),E(n)&&(s=u(e,c,s)),T(n)&&(s=f(t,r,c,s)),o&&(s=d(o,c,s)),c},o.decode=function(e){var n=new p(e),t=n.length||n.byteLength,r=0,o=0,i=null,c=n[r++],s=1&c,l=c>>1&7;if(E(l)){var a=parseInt(n[r]),u=0;do{o+=(127&(a=parseInt(n[r])))*Math.pow(2,7*u),r++,u++}while(128<=a)}if(T(l))if(s)i=n[r++]<<8|n[r++];else{var f=n[r++];i=f?(i=new p(f),v(i,0,n,r,f),y.strdecode(i)):"",r+=f}var d=t-r,h=new p(d);return v(h,0,n,r,d),{id:o,type:l,compressRoute:s,route:i,body:h}};var v=function(e,n,t,r,o){if("function"==typeof t.copy)t.copy(e,n,r,r+o);else for(var i=0;i<o;i++)e[n++]=t[r++]},E=function(e){return e===o.TYPE_REQUEST||e===o.TYPE_RESPONSE},T=function(e){return e===o.TYPE_REQUEST||e===o.TYPE_NOTIFY||e===o.TYPE_PUSH},l=function(e){for(var n=0;n+=1,0<(e>>=7););return n},a=function(e,n,t,r){if(e!==o.TYPE_REQUEST&&e!==o.TYPE_NOTIFY&&e!==o.TYPE_RESPONSE&&e!==o.TYPE_PUSH)throw new Error("unkonw message type: "+e);return t[r]=e<<1|(n?1:0),r+1},u=function(e,n,t){do{var r=e%128,o=Math.floor(e/128);0!==o&&(r+=128),n[t++]=r,e=o}while(0!==e);return t},f=function(e,n,t,r){if(e){if(65535<n)throw new Error("route number is overflow");t[r++]=n>>8&255,t[r++]=255&n}else n?(t[r++]=255&n.length,v(t,r,n,0,n.length),r+=n.length):t[r++]=0;return r},d=function(e,n,t){return v(n,t,e,0,e.length),t+e.length};"undefined"!=typeof window&&(window.Protocol=y)}("undefined"==typeof window?module.exports:this.Protocol={},"undefined"==typeof window?Buffer:Uint8Array),function(){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}t.prototype.on=t.prototype.addEventListener=function(e,n){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(n),this},t.prototype.once=function(e,n){var t=this;function r(){t.off(e,r),n.apply(this,arguments)}return this._callbacks=this._callbacks||{},r.fn=n,this.on(e,r),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,n){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var t,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var o=0;o<r.length;o++)if((t=r[o])===n||t.fn===n){r.splice(o,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var n=[].slice.call(arguments,1),t=this._callbacks[e];if(t)for(var r=0,o=(t=t.slice(0)).length;r<o;++r)t[r].apply(this,n);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length};var i=window.Protocol,c=i.Package,s=i.Message,e=t,l=window.rsa;"function"!=typeof Object.create&&(Object.create=function(e){function n(){}return n.prototype=e,new n});var n=window,o=Object.create(e.prototype);n.nano=o;var a,u=null,r=0,f={},d={},h={},p={},y={},v=0,E=0,T=0,_=null,b=null,m=null,g=null,w=null,P=!1,Y=!1,S=null,A=null,k=0,N=5e3,O=!1,H=[],R={sys:{rsa:{},platform:"",libVersion:"",clientBuildNumber:"",clientVersion:""},user:{}},K=null;o.init=function(e,n){K=n;var t=e.host,r=e.port,o=e.path;w=e.encode||I,g=e.decode||D;var i="ws://"+t;if(r&&(i+=":"+r),o&&(i+=o),R.sys.platform=e.platform||"",R.sys.libVersion="0.0.1",R.sys.clientBuildNumber=e.clientBuildNumber||"",R.sys.clientVersion=e.clientVersion||"",R.user=e.user,e.encrypt){a=!0,l.generate(1024,"10001");var c={rsa_n:l.n.toString(16),rsa_e:l.e};R.sys.rsa=c}m=e.handshakeCallback,U(e,i,n)};var D=o.decode=function(e){var n=s.decode(e);if(!(0<n.id)||(n.route=h[n.id],delete h[n.id],n.route))return n.body=Q(n),n},I=o.encode=function(e,n,t){var r=e?s.TYPE_REQUEST:s.TYPE_NOTIFY;t=i.strencode(JSON.stringify(t));var o=0;return p&&p[n]&&(n=p[n],o=1),s.encode(e,r,o,n,t)},U=function(n,e,t){console.log("connect to "+e);var r=(n=n||{}).maxReconnectAttempts||10;A=e,Y=!!n.reconnect;(u=new WebSocket(e)).binaryType="arraybuffer",u.onopen=function(e){P&&o.emit("reconnectSuccess"),C();var n=c.encode(c.TYPE_HANDSHAKE,i.strencode(JSON.stringify(R)));J(n),O=!1},u.onmessage=function(e){q(c.decode(e.data),t),E&&(T=Date.now()+E)},u.onerror=function(e){o.emit("io-error",e),console.error("socket error: ",e)},u.onclose=function(e){o.emit("close",e),console.log("socket close: ",e),O=!1,_&&(clearTimeout(_),_=null),b&&(clearTimeout(b),b=null),Y&&(k<r?(P=!0,k++,S=setTimeout(function(){U(n,A,t)},N),o.emit("reconnect",k)):o.emit("reconnectFail"))}};o.disconnect=function(e){0==(e=e||0)&&(Y=!1),u&&(u.disconnect&&u.disconnect(),u.close&&u.close(),console.log("disconnect"),u=null),_&&(clearTimeout(_),_=null),b&&(clearTimeout(b),b=null),S&&0==e&&(clearTimeout(S),S=null)};var C=function(){P=!1,N=5e3,k=0,clearTimeout(S)};o.request=function(e,n,t){n=2===arguments.length&&"function"==typeof n?(t=n,{}):n||{},e&&(r++,O?(B(r,e,n),f[r]=t,h[r]=e):H.push({reqId:r,route:e,msg:n,cb:t}))},o.notify=function(e,n){n=n||{},e&&(O?B(0,e,n):H.push({reqId:0,route:e,msg:n}))};var B=function(e,n,t){if(a){t=JSON.stringify(t);var r=l.signString(t,"sha256");(t=JSON.parse(t)).__crypto__=r}w&&(t=w(e,n,t));var o=c.encode(c.TYPE_DATA,t);J(o)},J=function(e){u?u.send(e.buffer):console.error("send fail socket is disconnect")},L=function(){var e=T-Date.now();100<e?b=setTimeout(L,e):(console.error("server heartbeat timeout"),o.emit("heartbeat timeout"),o.disconnect(-1))};d[c.TYPE_HANDSHAKE]=function(e){if(501!==(e=JSON.parse(i.strdecode(e))).code)if(200===e.code){V(e);var n=c.encode(c.TYPE_HANDSHAKE_ACK);J(n),K&&K(u)}else o.emit("error","handshake fail");else o.emit("error","client version not fullfill")},d[c.TYPE_HEARTBEAT]=function(e){if(v){var n=c.encode(c.TYPE_HEARTBEAT);b&&(clearTimeout(b),b=null),_=_||setTimeout(function(){_=null,J(n),T=Date.now()+E,b=setTimeout(L,E)},v)}},d[c.TYPE_DATA]=function(e){var n=e;g&&(n=g(n)),F(o,n)},d[c.TYPE_KICK]=function(e){e=e?JSON.parse(i.strdecode(e)):{},Y=!1,o.emit("onKick",e)};var q=function(e){if(Array.isArray(e))for(var n=0;n<e.length;n++){var t=e[n];d[t.type](t.body)}else d[e.type](e.body)},F=function(e,n){if(n.id){var t=f[n.id];delete f[n.id],"function"==typeof t&&t(n.body)}else e.emit(n.route,n.body)},Q=function(e){var n=e.route;if(e.compressRoute){if(!y[n])return{};n=e.route=y[n]}return JSON.parse(i.strdecode(e.body))},V=function(e){E=e.sys&&e.sys.heartbeat?2*(v=1e3*e.sys.heartbeat):v=0,M(e),O=!0;for(var n=0;n<H.length;n++){var t=H[n];0<t.reqId?o.request(t.route,t.msg,t.cb):o.notify(t.route,t.msg)}H=[],"function"==typeof m&&e.sys&&m(e.sys.serializer)},M=function(e){if(e&&e.sys){if(p=e.sys.dict)for(var n in y={},p=p)y[p[n]]=n;window.nano=o}}}();