!function(e,p){var y=e,n=y.Package={},o=y.Message={};n.TYPE_HANDSHAKE=1,n.TYPE_HANDSHAKE_ACK=2,n.TYPE_HEARTBEAT=3,n.TYPE_DATA=4,n.TYPE_KICK=5,o.TYPE_REQUEST=0,o.TYPE_NOTIFY=1,o.TYPE_RESPONSE=2,o.TYPE_PUSH=3,y.strencode=function(e){for(var n=new p(3*e.length),t=0,r=0;r<e.length;r++)for(var o=e.charCodeAt(r),i=null,i=o<=127?[o]:o<=2047?[192|o>>6,128|63&o]:[224|o>>12,128|(4032&o)>>6,128|63&o],c=0;c<i.length;c++)n[t]=i[c],++t;var s=new p(t);return E(s,0,n,0,t),s},y.strdecode=function(e){for(var n=e.length?e:new p(e),t="",r=[],o=0,i=0,c=n.length;o<c;)n[o]<128?(i=n[o],o+=1):n[o]<224?(i=((63&n[o])<<6)+(63&n[o+1]),o+=2):(i=((15&n[o])<<12)+((63&n[o+1])<<6)+(63&n[o+2]),o+=3),r.push(i),1e4<r.length&&(t+=String.fromCharCode.apply(null,r),r=[]);return r.length&&(t+=String.fromCharCode.apply(null,r)),t},n.encode=function(e,n){var t=n?n.length:0,r=new p(4+t),o=0;return r[o++]=255&e,r[o++]=t>>16&255,r[o++]=t>>8&255,r[o++]=255&t,n&&E(r,4,n,0,t),r},n.decode=function(e){for(var n=0,t=new p(e),r=0,o=[];n<t.length;){var i=t[n++],c=(r=(t[n++]<<16|t[n++]<<8|t[n++])>>>0)?new p(r):null;E(c,0,t,n,r),n+=r,o.push({type:i,body:c})}return 1===o.length?o[0]:o},o.encode=function(e,n,t,r,o){var i=1+(v(n)?l(e):0);if(T(n))if(t){if("number"!=typeof r)throw new Error("error flag for number route!");i+=2}else if(i+=1,r){if(255<(r=y.strencode(r)).length)throw new Error("route maxlength is overflow");i+=r.length}o&&(i+=o.length);var c=new p(i),s=a(n,t,c,s=0);return v(n)&&(s=u(e,c,s)),T(n)&&(s=f(t,r,c,s)),o&&(s=d(o,c,s)),c},o.decode=function(e){var n,t=new p(e),r=t.length||t.byteLength,o=0,i=0,c=null,s=t[o++],l=1&s,a=s>>1&7;if(v(a)){var u=parseInt(t[o]),f=0;do{i+=(127&(u=parseInt(t[o])))*Math.pow(2,7*f),o++,f++}while(128<=u)}T(a)&&(l?c=t[o++]<<8|t[o++]:(c=(n=t[o++])?(c=new p(n),E(c,0,t,o,n),y.strdecode(c)):"",o+=n));var d=r-o,h=new p(d);return E(h,0,t,o,d),{id:i,type:a,compressRoute:l,route:c,body:h}};var E=function(e,n,t,r,o){if("function"==typeof t.copy)t.copy(e,n,r,r+o);else for(var i=0;i<o;i++)e[n++]=t[r++]},v=function(e){return e===o.TYPE_REQUEST||e===o.TYPE_RESPONSE},T=function(e){return e===o.TYPE_REQUEST||e===o.TYPE_NOTIFY||e===o.TYPE_PUSH},l=function(e){for(var n=0;n+=1,0<(e>>=7););return n},a=function(e,n,t,r){if(e!==o.TYPE_REQUEST&&e!==o.TYPE_NOTIFY&&e!==o.TYPE_RESPONSE&&e!==o.TYPE_PUSH)throw new Error("unkonw message type: "+e);return t[r]=e<<1|(n?1:0),r+1},u=function(e,n,t){do{var r=e%128,o=Math.floor(e/128);0!==o&&(r+=128),n[t++]=r,e=o}while(0!==e);return t},f=function(e,n,t,r){if(e){if(65535<n)throw new Error("route number is overflow");t[r++]=n>>8&255,t[r++]=255&n}else n?(t[r++]=255&n.length,E(t,r,n,0,n.length),r+=n.length):t[r++]=0;return r},d=function(e,n,t){return E(n,t,e,0,e.length),t+e.length};"undefined"!=typeof window&&(window.Protocol=y)}("undefined"==typeof window?module.exports:this.Protocol={},"undefined"==typeof window?Buffer:Uint8Array),function(){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}t.prototype.on=t.prototype.addEventListener=function(e,n){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(n),this},t.prototype.once=function(e,n){var t=this;function r(){t.off(e,r),n.apply(this,arguments)}return this._callbacks=this._callbacks||{},r.fn=n,this.on(e,r),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,n){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var t,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var o=0;o<r.length;o++)if((t=r[o])===n||t.fn===n){r.splice(o,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var n=[].slice.call(arguments,1),t=this._callbacks[e];if(t)for(var r=0,o=(t=t.slice(0)).length;r<o;++r)t[r].apply(this,n);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length};var i=window.Protocol,c=i.Package,s=i.Message,e=t,l=window.rsa;"function"!=typeof Object.create&&(Object.create=function(e){function n(){}return n.prototype=e,new n});var n=window,a=Object.create(e.prototype);n.nano=a;var o,u,f=null,r=0,d={},h={},p={},y={},E={},v=0,T=0,_=0,g=null,b=null,m=null,w=null,P=null,S=!1,Y=!1,k=null,A=0,N=100,O=!1,H=[],R={sys:{rsa:{},platform:"",libVersion:"",clientBuildNumber:"",clientVersion:""},user:{}},K=null;a.init=function(e,n){a.disconnect(0),K=n;var t=e.host,r=e.port,o=e.path;P=e.encode||I,w=e.decode||D;var i,c="ws://"+t;r&&(c+=":"+r),o&&(c+=o),R.sys.platform=e.platform||"",R.sys.libVersion="0.0.1",R.sys.clientBuildNumber=e.clientBuildNumber||"",R.sys.clientVersion=e.clientVersion||"",R.user=e.user,e.encrypt&&(u=!0,l.generate(1024,"10001"),i={rsa_n:l.n.toString(16),rsa_e:l.e},R.sys.rsa=i),m=e.handshakeCallback,C(e,c,n)};var D=a.decode=function(e){var n=s.decode(e);if(!(0<n.id)||(n.route=p[n.id],delete p[n.id],n.route))return n.body=Q(n),n},I=a.encode=function(e,n,t){var r=e?s.TYPE_REQUEST:s.TYPE_NOTIFY;t=i.strencode(JSON.stringify(t));var o=0;return y&&y[n]&&(n=y[n],o=1),s.encode(e,r,o,n,t)},C=function(n,e,t){console.log("connect to "+e);var r=(n=n||{}).maxReconnectAttempts||10;o=e,Y=!!n.reconnect;(f=new WebSocket(e)).binaryType="arraybuffer",f.onopen=function(e){S&&a.emit("reconnectSuccess"),U();var n=c.encode(c.TYPE_HANDSHAKE,i.strencode(JSON.stringify(R)));J(n),O=!1},f.onmessage=function(e){q(c.decode(e.data),t),T&&(_=Date.now()+T)},f.onerror=function(e){a.emit("io-error",e),console.error("socket error: ",e)},f.onclose=function(e){a.emit("close",e),console.log("socket close: ",e),O=!1,g&&(clearTimeout(g),g=null),b&&(clearTimeout(b),b=null),Y&&(A<r?(S=!0,A++,k=setTimeout(function(){C(n,o,t)},N),a.emit("reconnect",A)):a.emit("reconnectFail"))}};a.disconnect=function(e){0==(e=e||0)&&(Y=!1),f&&(f.disconnect&&f.disconnect(),f.close&&f.close(),console.log("disconnect"),f=null),g&&(clearTimeout(g),g=null),b&&(clearTimeout(b),b=null),k&&0==e&&(clearTimeout(k),k=null)};var U=function(){S=!1,N=100,A=0,clearTimeout(k)};a.request=function(e,n,t){n=2===arguments.length&&"function"==typeof n?(t=n,{}):n||{},e&&(r++,O?(B(r,e,n),d[r]=t,p[r]=e):H.push({reqId:r,route:e,msg:n,cb:t}))},a.notify=function(e,n){n=n||{},e&&(O?B(0,e,n):H.push({reqId:0,route:e,msg:n}))};var B=function(e,n,t){var r;u&&(t=JSON.stringify(t),r=l.signString(t,"sha256"),(t=JSON.parse(t)).__crypto__=r),P&&(t=P(e,n,t));var o=c.encode(c.TYPE_DATA,t);J(o)},J=function(e){f?f.send(e.buffer):console.error("send fail socket is disconnect")},L=function(){var e=_-Date.now();100<e?b=setTimeout(L,e):(console.error("server heartbeat timeout"),a.emit("heartbeat timeout"),a.disconnect(-1))};h[c.TYPE_HANDSHAKE]=function(e){if(501!==(e=JSON.parse(i.strdecode(e))).code)if(200===e.code){V(e);var n=c.encode(c.TYPE_HANDSHAKE_ACK);J(n),K&&K(f);for(var t=0;t<H.length;t++){var r=H[t];0<r.reqId?a.request(r.route,r.msg,r.cb):a.notify(r.route,r.msg)}H=[]}else a.emit("error","handshake fail");else a.emit("error","client version not fullfill")},h[c.TYPE_HEARTBEAT]=function(e){var n;v&&(n=c.encode(c.TYPE_HEARTBEAT),b&&(clearTimeout(b),b=null),g=g||setTimeout(function(){g=null,J(n),_=Date.now()+T,b=setTimeout(L,T)},v))},h[c.TYPE_DATA]=function(e){var n=e;w&&(n=w(n)),F(a,n)},h[c.TYPE_KICK]=function(e){e=e?JSON.parse(i.strdecode(e)):{},Y=!1,a.emit("onKick",e)};var q=function(e){if(Array.isArray(e))for(var n=0;n<e.length;n++){var t=e[n];h[t.type](t.body)}else h[e.type](e.body)},F=function(e,n){var t;n.id?(t=d[n.id],delete d[n.id],"function"==typeof t&&t(n.body)):e._callbacks[n.route]?e.emit(n.route,n.body):console.error("not on (%s):",n.route,n.body)},Q=function(e){var n=e.route;if(e.compressRoute){if(!E[n])return{};n=e.route=E[n]}return JSON.parse(i.strdecode(e.body))},V=function(e){T=e.sys&&e.sys.heartbeat?2*(v=1e3*e.sys.heartbeat):v=0,M(e),O=!0,"function"==typeof m&&e.sys&&m(e.sys.serializer)},M=function(e){if(e&&e.sys){if(y=e.sys.dict)for(var n in E={},y)E[y[n]]=n;window.nano=a}}}();